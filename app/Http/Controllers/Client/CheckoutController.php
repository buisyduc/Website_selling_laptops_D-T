<?php

namespace App\Http\Controllers\Client;

use App\Http\Controllers\Controller;
use App\Models\coupon;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use App\Models\Order;
use App\Models\Cart;
use Illuminate\Support\Carbon;
use Illuminate\Support\Facades\Log;
use App\Models\User;
use App\Notifications\OrderPlaced;
use App\Mail\OrderMail;
use Illuminate\Support\Facades\Mail;

class CheckoutController extends Controller
{
    /**
     * B∆∞·ªõc 1: Hi·ªÉn th·ªã form nh·∫≠p th√¥ng tin ƒë·∫∑t h√†ng
     */
    public function index(Request $request)
    {
        $user = Auth::user();

        $cart = Cart::with(['items.variant.product', 'items.variant.options.attribute'])
            ->where('user_id', $user->id)
            ->first();

        if (!$cart || $cart->items->isEmpty()) {
            return redirect()->route('cart.index')->with('error', 'Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.');
        }

        $cartTotal = $cart->items->sum(fn($item) => $item->variant->price * $item->quantity);

        $order = null;

        // ∆Øu ti√™n l·∫•y t·ª´ session
        if (session()->has('current_order_id')) {
            $order = Order::with(['items.variant.product', 'items.variant.options.attribute', 'coupon'])
                ->where('id', session('current_order_id'))
                ->where('user_id', $user->id)
                ->where('status', 'unprocessed')
                ->first();
        }

        // N·∫øu kh√¥ng c√≥ order t·ª´ session th√¨ l·∫•y ƒë∆°n unprocessed m·ªõi nh·∫•t
        if (!$order) {
            $order = Order::with(['items.variant.product', 'items.variant.options.attribute', 'coupon'])
                ->where('user_id', $user->id)
                ->where('status', 'unprocessed')
                ->latest()
                ->first();
        }

        $appliedCoupon = $order->coupon ?? null;
        $discountAmount = $order->discount_amount ?? 0;
        $totalAmount = $cartTotal - $discountAmount;

        $availableCoupons = Coupon::where(function ($query) {
            $query->whereNull('expires_at')
                ->orWhere('expires_at', '>', now());
        })
            ->where(function ($query) {
                $query->whereNull('usage_limit')
                    ->orWhereColumn('used_count', '<', 'usage_limit');
            })
            ->get();



        $reorderInfo = session('reorder_shipping_info', []);

        return view('client.checkout.index', [
            'user' => $user,
            'cartItems' => $cart->items,
            'cartTotal' => $cartTotal,
            'totalAmount' => $totalAmount,
            'order' => $order,
            'appliedCoupon' => $appliedCoupon,
            'discountAmount' => $discountAmount,
            'availableCoupons' => $availableCoupons,
            'reorderInfo' => $reorderInfo,
        ]);
    }




    /**
     * B∆∞·ªõc 2: L∆∞u th√¥ng tin ƒë∆°n h√†ng v√†o DB v√† chuy·ªÉn ƒë·∫øn trang thanh to√°n
     */
    public function store(Request $request)
    {
        $user = Auth::user();

        // Validate th√¥ng tin ƒë∆°n h√†ng
        $request->validate([
            'email' => 'required|email',
            'name' => 'required|string|max:255',
            'phone' => 'required|string|max:20',
            'province' => 'required|string|max:255',
            'district' => 'required|string|max:255',
            'ward' => 'required|string|max:255',
            'address' => 'required|string|max:255',
            'note' => 'nullable|string',

        ]);

        Log::info('D·ªØ li·ªáu g·ª≠i v√†o request:', $request->all());

        // L·∫•y gi·ªè h√†ng hi·ªán t·∫°i
        $cart = Cart::with('items.variant.product')
            ->where('user_id', $user->id)
            ->first();

        if (!$cart || $cart->items->isEmpty()) {
            return redirect()->route(route: 'cart.index')->with('error', 'Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.');
        }

        // T√≠nh t·ªïng ti·ªÅn
        $total = $cart->items->sum(fn($item) => $item->variant->price * $item->quantity);

        // G·ªôp ƒë·ªãa ch·ªâ
        $shippingAddress = implode(', ', array_filter([
            $request->address,
            $request->ward,
            $request->district,
            $request->province,
        ]));

        // üîç T√¨m ƒë∆°n h√†ng `unprocessed` hi·ªán t·∫°i (n·∫øu c√≥)
        $order = Order::where('user_id', $user->id)
            ->where('status', 'unprocessed') // Ch·ªâ l·∫•y ƒë∆°n h√†ng ch∆∞a x·ª≠ l√Ω
            ->latest()
            ->first();

        if ($order) {
            // ‚úÖ N·∫øu ƒë√£ t·ªìn t·∫°i, c·∫≠p nh·∫≠t l·∫°i th√¥ng tin
            $order->update([
                'name'             => $request->name,
                'email'            => $request->email,
                'phone'            => $request->phone,
                'shipping_address' => $shippingAddress,
                'province'         => $request->province,
                'district'         => $request->district,
                'ward'             => $request->ward,
                'address'          => $request->address,
                'note'             => $request->note,
            ]);

            // X√≥a item c≈© r·ªìi th√™m l·∫°i n·∫øu c·∫ßn (n·∫øu b·∫°n mu·ªën c·∫≠p nh·∫≠t theo cart)
            $order->items()->delete();
        } else {
            // ‚úÖ N·∫øu ch∆∞a c√≥ th√¨ t·∫°o m·ªõi
            $order = Order::create([
                'user_id'          => $user->id,
                'name'             => $request->name,
                'email'            => $request->email,
                'phone'            => $request->phone,
                'coupon_id'        => null,
                'order_code'       => strtoupper('OD' . now()->format('YmdHis') . rand(100, 999)),
                'total_amount'     => null, // T·ªïng ti·ªÅn s·∫Ω ƒë∆∞·ª£c t√≠nh sau khi √°p d·ª•ng m√£ gi·∫£m gi√°
                'status'           => 'unprocessed', // ƒê·∫∑t tr·∫°ng th√°i ban ƒë·∫ßu l√† 'unprocessed'
                'payment_method'   => null,
                'payment_status'   => 'unpaid',
                'shipping_address' => $shippingAddress,
                'shipping_method'  => 'home_delivery',
                'shipping_fee'     => 0,
                'discount_amount'  => 0,
                'note'             => $request->note,
                'province'         => $request->province,
                'district'         => $request->district,
                'ward'             => $request->ward,
                'address'          => $request->address,
            ]);
        }

        // D√π update hay create ƒë·ªÅu th√™m l·∫°i OrderItem t·ª´ gi·ªè h√†ng
        foreach ($cart->items as $item) {
            $order->items()->create([
                'product_id'   => $item->variant->product_id,
                'variant_id'   => $item->variant_id,
                'price'        => $item->variant->price,
                'quantity'     => $item->quantity,
                'product_name' => $item->variant->product->name,
            ]);
        }

        // Ghi l·∫°i order_id v√†o session n·∫øu c·∫ßn
        session(['current_order_id' => $order->id]);

        // N·∫øu l√† AJAX
        if ($request->expectsJson()) {
            return response()->json([
                'success' => true,
                'order_id' => $order->id,
                'message' => 'Th√¥ng tin ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!'
            ]);
        }

        return redirect()->back()->with([
            'success' => 'Th√¥ng tin ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!',
            'order_id' => $order->id,
            'switch_to_payment' => true
        ]);
    }
    public function paymentStore(Request $request)
    {
        Log::info('D·ªØ li·ªáu g·ª≠i v√†o request:', $request->all());

        $user = auth()->user();

        $order = Order::where('user_id', $user->id)
            ->where('status', 'unprocessed')
            ->latest()
            ->firstOrFail();

        $cartTotal = $order->items->sum(fn($item) => $item->variant->price * $item->quantity);

        // T√≠nh gi·∫£m gi√°
        $discountAmount = 0;
        $coupon = null;

        if ($request->filled('coupon_id')) {
            $coupon = Coupon::find($request->coupon_id);
            if ($coupon) {
                $discountAmount = round($cartTotal * ($coupon->discount_percent / 100));
                $discountAmount = min($discountAmount, $coupon->max_discount);
            }
        }

        $totalAmount = $cartTotal - $discountAmount;


        // Ki·ªÉm tra t·ªìn kho tr∆∞·ªõc khi x·ª≠ l√Ω (nh∆∞ng ch∆∞a tr·ª´ kho)
        foreach ($order->items as $item) {
            $variant = $item->variant;
            if ($variant && $variant->stock_quantity !== null) {
                if ($variant->stock_quantity < $item->quantity) {
                    return redirect()->route('checkout.index', ['orderId' => $order->id])
                        ->with('error', 'S·∫£n ph·∫©m "' . $variant->product->name . '" ch·ªâ c√≤n ' . $variant->stock_quantity . ' trong kho.');
                }
            }
        }

        // ‚úÖ Ch·ªâ c·∫≠p nh·∫≠t tr·∫°ng th√°i v√† payment_status cho COD, KH√îNG c·∫≠p nh·∫≠t cho VNPay ·ªü ƒë√¢y
        if ($request->payment_method === 'vnpay') {
            // V·ªõi VNPay: KH√îNG c·∫≠p nh·∫≠t payment_method, payment_status, status ·ªü ƒë√¢y
            // Ch·ªâ c·∫≠p nh·∫≠t c√°c th√¥ng tin kh√°c n·∫øu c·∫ßn (coupon, note, ph√≠ ship...)
            $order->update([
                'total_amount'    => $totalAmount,
                'discount_amount' => $discountAmount,
                'shipping_fee'    => $request->shipping_fee ?? 0,
                'shipping_method' => $request->shipping_method ?? $order->shipping_method ?? 'home_delivery',
                'coupon_id'       => $request->coupon_id,
                'note'            => $request->note,
                'confirmed_at'    => now(),
            ]);

            // Chuy·ªÉn h∆∞·ªõng sang VNPay, vi·ªác c·∫≠p nh·∫≠t payment_method, status, payment_status s·∫Ω l√†m ·ªü handleReturn
            return redirect()->route('vnpay.redirect', ['orderId' => $order->id]);
        } else {
            // COD: c·∫≠p nh·∫≠t ƒë·∫ßy ƒë·ªß tr·∫°ng th√°i ƒë∆°n h√†ng
            $order->update([
                'total_amount'    => $totalAmount,
                'discount_amount' => $discountAmount,
                'shipping_fee'    => $request->shipping_fee ?? 0,
                'shipping_method' => $request->shipping_method ?? $order->shipping_method ?? 'home_delivery',
                'payment_method'  => $request->payment_method,
                'payment_status'  => 'unpaid',
                'status'          => 'pending',
                'coupon_id'       => $request->coupon_id,
                'note'            => $request->note,
                'confirmed_at'    => now(),
            ]);

            // Tr·ª´ kho
            foreach ($order->items as $item) {
                $variant = $item->variant;
                if ($variant && $variant->stock_quantity !== null) {
                    $variant->decrement('stock_quantity', $item->quantity);
                }
            }

            // C·ªông l∆∞·ª£t d√πng m√£ gi·∫£m gi√°
            if ($request->filled('coupon_id') && $coupon) {
                $coupon->increment('used_count');
            }

            // Xo√° gi·ªè h√†ng
            if ($cart = Cart::where('user_id', $user->id)->first()) {
                $cart->items()->delete();
                $cart->delete();
            }
            Mail::to($order->user->email)->send(new OrderMail($order, 'new'));
            
            // Th√¥ng b√°o cho admin: c√≥ ƒë∆°n h√†ng m·ªõi (COD)
            try {
                $admins = User::where('role', 'admin')->get();
                foreach ($admins as $admin) {
                    $admin->notify(new OrderPlaced($order));
                }
            } catch (\Throwable $e) {
                Log::warning('Kh√¥ng th·ªÉ g·ª≠i th√¥ng b√°o OrderPlaced (COD): ' . $e->getMessage());
            }


            // COD: Chuy·ªÉn th·∫≥ng t·ªõi trang c·∫£m ∆°n
            return redirect()->route('checkout.orderInformation', $order->id)->with('success', 'ƒê·∫∑t h√†ng th√†nh c√¥ng!');
        }
    }

    /**
     * Ho√†n t·∫•t thanh to√°n
     */
    public function completePayment($orderId)
    {
        $order = Order::where('id', $orderId)
            ->where('user_id', auth()->id())
            ->firstOrFail();

        // Xo√° gi·ªè h√†ng sau khi thanh to√°n
        $cart = Cart::where('user_id', auth()->id())->first();
        if ($cart) {
            $cart->items()->delete();
            $cart->delete();
        }

        foreach ($order->items as $item) {
            $variant = $item->variant;

            if ($variant && $variant->stock_quantity !== null) {
                if ($variant->stock_quantity >= $item->quantity) {
                    $variant->decrement('stock_quantity', $item->quantity);

                    // Load l·∫°i t·ª´ DB ƒë·ªÉ ki·ªÉm tra s·ªë l∆∞·ª£ng m·ªõi
                    $updatedVariant = $variant->fresh();

                    dd([
                        'variant_id' => $variant->id,
                        'stock_quantity_sau_khi_tru' => $updatedVariant->stock_quantity,
                        'da_tru_bao_nhieu' => $item->quantity,
                    ]);
                } else {
                    return redirect()->route('checkout.index', ['orderId' => $order->id])
                        ->with('error', 'S·∫£n ph·∫©m "' . $item->variant->product->name . '" kh√¥ng c√≤n ƒë·ªß s·ªë l∆∞·ª£ng.');
                }
            }
        }

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng
        $order->update([
            'payment_status' => 'paid',
            'status'         => 'processing',
        ]);

        return redirect()->route('orders.success')->with('success', 'ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c thanh to√°n!');
    }





    public function applyCoupon(Request $request)
    {
        if (!auth()->check()) {
            return response()->json(['error' => 'Ch∆∞a ƒëƒÉng nh·∫≠p!'], 401);
        }

        if (auth()->user()->role !== 'customer') {
            return response()->json(['error' => 'Ch·ªâ kh√°ch h√†ng m·ªõi ƒë∆∞·ª£c √°p d·ª•ng m√£!'], 403);
        }

        $coupon = Coupon::where('code', $request->code)->first();
        if (!$coupon) {
            return response()->json(['error' => 'M√£ gi·∫£m gi√° kh√¥ng t·ªìn t·∫°i!'], 404);
        }

        // L·∫•y gi·ªè h√†ng v√† t·ªïng t·∫°m t√≠nh
        $cart = Cart::where('user_id', auth()->id())->with('items.variant.product')->first();

        if (!$cart || $cart->items->isEmpty()) {
            return response()->json(['error' => 'Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng!'], 400);
        }

        // T√≠nh t·ªïng ti·ªÅn t·ª´ c√°c item (gi√° * s·ªë l∆∞·ª£ng)
        $originalTotal = $cart->items->sum(function ($item) {
            return $item->variant->price * $item->quantity;
        });

        // Ki·ªÉm tra ƒëi·ªÅu ki·ªán √°p d·ª•ng (v√≠ d·ª•: ƒë∆°n t·ªëi thi·ªÉu)
        if ($originalTotal < $coupon->min_order_amount) {
            return response()->json([
                'error' => 'ƒê∆°n h√†ng ph·∫£i ƒë·∫°t t·ªëi thi·ªÉu ' . number_format($coupon->min_order_amount, 0, ',', '.') . '‚Ç´ ƒë·ªÉ √°p d·ª•ng m√£ n√†y!'
            ], 422);
        }
        if (now()->greaterThan($coupon->expiry_date)) {
            return response()->json(['error' => 'M√£ gi·∫£m gi√° ƒë√£ h·∫øt h·∫°n!'], 410);
        }
        if ($coupon->usage_limit && $coupon->used_count >= $coupon->usage_limit) {
            return response()->json(['error' => 'M√£ gi·∫£m gi√° ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng h·∫øt!'], 429);
        }

        // T√≠nh gi·∫£m gi√° v√† gi·ªõi h·∫°n theo max_discount
        $discount = ($originalTotal * $coupon->discount_percent / 100);
        $discount = min($discount, $coupon->max_discount);

        return response()->json([
            'code'            => $coupon->code,
            'coupon_id'       => $coupon->id,
            'discount_amount' => $discount,
            'total_amount'    => $originalTotal - $discount,
        ]);
    }
    public function orderInformation($orderId)
    {
        session()->forget('reorder_shipping_info');
        session()->forget('is_reorder');
        // L·∫•y th√¥ng tin ƒë∆°n h√†ng v·ª´a t·∫°o ƒë·ªÉ x√°c ƒë·ªãnh tr·∫°ng th√°i
        $currentOrder = Order::where('user_id', Auth::id())->findOrFail($orderId);

        // L·∫•y t·∫•t c·∫£ ƒë∆°n h√†ng c√≥ c√πng tr·∫°ng th√°i v·ªõi ƒë∆°n v·ª´a t·∫°o
        $orders = Order::with([
            'items',
            'items.product',
            'items.variant.options.attribute',
            'items.variant.options.option'
        ])
            ->where('user_id', Auth::id())
            ->where('status', $currentOrder->status)
            ->orderByDesc('created_at')
            ->get();

        // T·∫°o th√¥ng b√°o th√†nh c√¥ng d·ª±a tr√™n tr·∫°ng th√°i
        $statusMessage = '';
        if ($currentOrder->status === 'pending') {
            $statusMessage = 'ƒê·∫∑t h√†ng th√†nh c√¥ng! Vui l√≤ng thanh to√°n ƒë·ªÉ ho√†n t·∫•t ƒë∆°n h√†ng.';
        } elseif ($currentOrder->status === 'processing_seller') {
            $statusMessage = 'ƒê·∫∑t h√†ng v√† thanh to√°n th√†nh c√¥ng! ƒê∆°n h√†ng ƒëang ƒë∆∞·ª£c chu·∫©n b·ªã.';
        } else {
            $statusMessage = 'ƒê·∫∑t h√†ng th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ mua h√†ng t·∫°i D&T.';
        }

        // Truy·ªÅn tr·∫°ng th√°i hi·ªán t·∫°i ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng tab
        request()->merge(['status' => $currentOrder->status]);

        return view('client.user.purchase_order', compact('orders'))
            ->with('success', $statusMessage);
    }
}
